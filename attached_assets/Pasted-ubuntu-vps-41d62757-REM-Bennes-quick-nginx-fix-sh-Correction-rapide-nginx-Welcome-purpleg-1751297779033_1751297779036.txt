ubuntu@vps-41d62757:~/REM-Bennes$ ./quick-nginx-fix.sh
🔧 Correction rapide nginx Welcome - purpleguy.world
==================================================
🛑 Arrêt nginx système...
🧹 Libération port 80...
 43445 43452🔄 Recreation conteneurs Docker...
Stopping rem-bennes_nginx_1    ... done
Stopping rem-bennes_app_1      ... done
Stopping rem-bennes_postgres_1 ... done
Stopping rem-bennes_certbot_1  ... done
Stopping rem-bennes_redis_1    ... done
Removing rem-bennes_nginx_1    ... done
Removing rem-bennes_app_1      ... done
Removing rem-bennes_postgres_1 ... done
Removing rem-bennes_certbot_1  ... done
Removing rem-bennes_redis_1    ... done
Removing network rem-bennes_default
Removing volume rem-bennes_postgres_data
Removing volume rem-bennes_redis_data
🚀 Redémarrage services...
Creating network "rem-bennes_default" with the default driver
Creating volume "rem-bennes_postgres_data" with default driver
Creating volume "rem-bennes_redis_data" with default driver
Building app
DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
            Install the buildx component to build images with BuildKit:
            https://docs.docker.com/go/buildx/

error checking context: no permission to read from '/home/ubuntu/REM-Bennes/certbot/conf/archive/purpleguy.world/privkey2.pem'
ERROR: Service 'app' failed to build : Build failed
⏳ Attente démarrage (20s)...
🧪 Test résultat:
✅ SUCCÈS: Site accessible sans page Welcome
   http://purpleguy.world fonctionne correctement

📊 État final:
Name   Command   State   Ports
------------------------------
ubuntu@vps-41d62757:~/REM-Bennes$ curl http://purpleguy.world
curl: (7) Failed to connect to purpleguy.world port 80 after 4 ms: Could not connect to server
ubuntu@vps-41d62757:~/REM-Bennes$ sudo curl http://purpleguy.world
curl: (7) Failed to connect to purpleguy.world port 80 after 4 ms: Could not connect to server
ubuntu@vps-41d62757:~/REM-Bennes$ ./ssl-fix-complete.sh
🔐 SOLUTION COMPLÈTE SSL - purpleguy.world
==========================================
🔍 Identification des services sur le port 80...
Services sur port 80:

🛑 Arrêt services Docker...
⏳ Attente libération port 80...
📁 Création des dossiers SSL...
🚀 Démarrage nginx temporaire pour validation SSL...
8157c99c87878c622ec7cb7e9ce627eb7e827e614592f68f7feec6d7f27e14c1
🧪 Test serveur ACME...
✅ Serveur ACME opérationnel
🔐 Obtention certificat SSL Let's Encrypt...
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Certificate not yet due for renewal

You have an existing certificate that has exactly the same domains or certificate name you requested and isn't close to expiry.
(ref: /etc/letsencrypt/renewal/purpleguy.world.conf)

What would you like to do?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: Keep the existing certificate for now
2: Renew & replace the certificate (may be subject to CA rate limits)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): An unexpected error occurred:
EOFError
Ask for help or search for solutions at https://community.letsencrypt.org. See the logfile /var/log/letsencrypt/letsencrypt.log or re-run Certbot with -v for more details.
✅ Certificat SSL obtenu avec succès!
📋 Détails du certificat:
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Found the following certs:
  Certificate Name: purpleguy.world
    Serial Number: 58b05c6f7344201c0a63869ad9821022fe8
    Key Type: ECDSA
    Domains: purpleguy.world www.purpleguy.world
    Expiry Date: 2025-09-28 14:11:52+00:00 (VALID: 89 days)
    Certificate Path: /etc/letsencrypt/live/purpleguy.world/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/purpleguy.world/privkey.pem
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
🛑 Arrêt nginx temporaire...
nginx-acme
nginx-acme
⚙️ Configuration environnement HTTPS...
🔧 Configuration nginx finale...
✅ Utilisation configuration HTTPS complète
🚀 Démarrage services finaux...
Building app
DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
            Install the buildx component to build images with BuildKit:
            https://docs.docker.com/go/buildx/

Sending build context to Docker daemon  439.1MB
Step 1/17 : FROM node:18-alpine
 ---> ee77c6cd7c18
Step 2/17 : RUN apk add --no-cache     postgresql-client     curl     sed     && rm -rf /var/cache/apk/*
 ---> Running in 62dcddd72a39
fetch https://dl-cdn.alpinelinux.org/alpine/v3.21/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.21/community/x86_64/APKINDEX.tar.gz
(1/17) Installing brotli-libs (1.1.0-r2)
(2/17) Installing c-ares (1.34.5-r0)
(3/17) Installing libunistring (1.2-r0)
(4/17) Installing libidn2 (2.3.7-r0)
(5/17) Installing nghttp2-libs (1.64.0-r0)
(6/17) Installing libpsl (0.21.5-r3)
(7/17) Installing zstd-libs (1.5.6-r2)
(8/17) Installing libcurl (8.12.1-r1)
(9/17) Installing curl (8.12.1-r1)
(10/17) Installing postgresql-common (1.2-r1)
Executing postgresql-common-1.2-r1.pre-install
(11/17) Installing lz4-libs (1.10.0-r0)
(12/17) Installing libpq (17.5-r0)
(13/17) Installing ncurses-terminfo-base (6.5_p20241006-r3)
(14/17) Installing libncursesw (6.5_p20241006-r3)
(15/17) Installing readline (8.2.13-r0)
(16/17) Installing postgresql17-client (17.5-r0)
(17/17) Installing sed (4.9-r2)
Executing busybox-1.37.0-r12.trigger
Executing postgresql-common-1.2-r1.trigger
* Setting postgresql17 as the default version
WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.21/main: No such file or directory
WARNING: opening from cache https://dl-cdn.alpinelinux.org/alpine/v3.21/community: No such file or directory
OK: 19 MiB in 34 packages
 ---> Removed intermediate container 62dcddd72a39
 ---> 3b75625e840b
Step 3/17 : WORKDIR /app
 ---> Running in 4631f9e6d4dc
 ---> Removed intermediate container 4631f9e6d4dc
 ---> ec71c53e9000
Step 4/17 : COPY package*.json ./
 ---> 64059e42f97c
Step 5/17 : RUN npm ci --only=production
 ---> Running in 72ac7234bf75
npm warn config only Use `--omit=dev` to omit dev dependencies from the install.

added 504 packages, and audited 505 packages in 18s

71 packages are looking for funding
  run `npm fund` for details

2 vulnerabilities (1 low, 1 high)

To address issues that do not require attention, run:
  npm audit fix

Some issues need review, and may require choosing
a different dependency.

Run `npm audit` for details.
npm notice
npm notice New major version of npm available! 10.8.2 -> 11.4.2
npm notice Changelog: https://github.com/npm/cli/releases/tag/v11.4.2
npm notice To update run: npm install -g npm@11.4.2
npm notice
 ---> Removed intermediate container 72ac7234bf75
 ---> e9241a927673
Step 6/17 : COPY . .
 ---> e33f2cc6e69c
Step 7/17 : RUN mkdir -p logs uploads dist
 ---> Running in a17d72bdb4ec
 ---> Removed intermediate container a17d72bdb4ec
 ---> d3138a277a7c
Step 8/17 : RUN echo "🔧 Application du patch pour import.meta.dirname..." &&     cp server/vite.ts server/vite.ts.backup &&     sed -i '/import { createServer as createViteServer, createLogger } from "vite";/a import { fileURLToPath } from "url";' server/vite.ts &&     sed -i '/const viteLogger = createLogger();/i const __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n' server/vite.ts &&     sed -i 's/import\.meta\.dirname/__dirname/g' server/vite.ts &&     echo "✅ Patch appliqué avec succès" &&     if grep -q "__dirname" server/vite.ts && ! grep -q "import\.meta\.dirname" server/vite.ts; then         echo "✅ Patch confirmé - import.meta.dirname remplacé par __dirname";     else         echo "❌ Erreur de patch - restauration de la sauvegarde";         cp server/vite.ts.backup server/vite.ts;         exit 1;     fi
 ---> Running in f1e068095ba7
🔧 Application du patch pour import.meta.dirname...
✅ Patch appliqué avec succès
✅ Patch confirmé - import.meta.dirname remplacé par __dirname
 ---> Removed intermediate container f1e068095ba7
 ---> 33f0ee844f04
Step 9/17 : RUN npm run build
 ---> Running in e4d68e60912d

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.14 building for production...
transforming...
Browserslist: browsers data (caniuse-lite) is 8 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 3088 modules transformed.
rendering chunks...
computing gzip size...
../dist/public/index.html                                                  1.07 kB │ gzip:   0.61 kB
../dist/public/assets/667966dbb7a2c-bpfull_1749545669321-ZrB703mV.jpg      8.57 kB
../dist/public/assets/Face-B48vgf5s.png                                   11.47 kB
../dist/public/assets/cotédroit-CQvs7IRd.png                              20.17 kB
../dist/public/assets/cotégauche-BHQGJfEo.png                             35.40 kB
../dist/public/assets/22M3 petit man-Cdd_eOPf.png                         94.94 kB
../dist/public/assets/index-UROmFd9v.css                                  92.32 kB │ gzip:  15.59 kB
../dist/public/assets/purify.es-BFmuJLeH.js                               21.93 kB │ gzip:   8.62 kB
../dist/public/assets/index.es-BhlHfi3-.js                               150.57 kB │ gzip:  51.50 kB
../dist/public/assets/html2canvas.esm-CBrSDip1.js                        201.42 kB │ gzip:  48.03 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
../dist/public/assets/jspdf.es.min-CAc3NJGn.js                           357.69 kB │ gzip: 117.99 kB
../dist/public/assets/index-B6RjP4Vf.js                                1,112.03 kB │ gzip: 296.30 kB
✓ built in 18.12s

  dist/index.js  232.0kb

⚡ Done in 35ms
 ---> Removed intermediate container e4d68e60912d
 ---> bad285bc63a8
Step 10/17 : RUN addgroup -g 1001 -S nodejs
 ---> Running in 2164d3754f62
 ---> Removed intermediate container 2164d3754f62
 ---> dd9896ea9297
Step 11/17 : RUN adduser -S nodejs -u 1001
 ---> Running in 68636c44d2ea
 ---> Removed intermediate container 68636c44d2ea
 ---> 4c9949883543
Step 12/17 : RUN chown -R nodejs:nodejs /app
 ---> Running in b4d428cc8129
 ---> Removed intermediate container b4d428cc8129
 ---> 8a1e4935100b
Step 13/17 : USER nodejs
 ---> Running in 3525cc8dd252
 ---> Removed intermediate container 3525cc8dd252
 ---> 9710f8f1705b
Step 14/17 : EXPOSE 5000
 ---> Running in 69bef32613ef
 ---> Removed intermediate container 69bef32613ef
 ---> 0a809adc124b
Step 15/17 : ENV NODE_ENV=production
 ---> Running in ec12381db27b
 ---> Removed intermediate container ec12381db27b
 ---> acab98fc02ad
Step 16/17 : ENV PORT=5000
 ---> Running in 7cc77107d0b9
 ---> Removed intermediate container 7cc77107d0b9
 ---> 7a961706cfbb
Step 17/17 : CMD ["node", "dist/index.js"]
 ---> Running in 2f811e227690
 ---> Removed intermediate container 2f811e227690
 ---> 964a6de53cdb
Successfully built 964a6de53cdb
Successfully tagged rem-bennes_app:latest
Creating network "rem-bennes_default" with the default driver
Creating rem-bennes_redis_1    ... done
Creating rem-bennes_certbot_1  ... done
Creating rem-bennes_postgres_1 ... done
Creating rem-bennes_app_1      ... done
Creating rem-bennes_nginx_1    ... done
⏳ Attente démarrage complet...
🧪 Tests finaux...
❌ Site non accessible en HTTP
⚠️ Site non accessible en HTTPS

🎉 DÉPLOIEMENT SSL TERMINÉ
=========================

🔐 HTTPS activé:
   https://purpleguy.world
   https://www.purpleguy.world

📊 État des services:
        Name                       Command                 State                       Ports
--------------------------------------------------------------------------------------------------------------
rem-bennes_app_1        docker-entrypoint.sh node  ...   Up           0.0.0.0:5000->5000/tcp,:::5000->5000/tcp
rem-bennes_certbot_1    /bin/sh -c trap exit TERM; ...   Up           443/tcp, 80/tcp
rem-bennes_nginx_1      /docker-entrypoint.sh /bin ...   Restarting
rem-bennes_postgres_1   docker-entrypoint.sh postgres    Up           0.0.0.0:5432->5432/tcp,:::5432->5432/tcp
rem-bennes_redis_1      docker-entrypoint.sh redis ...   Up           0.0.0.0:6379->6379/tcp,:::6379->6379/tcp

🔍 Ports utilisés:

💡 Commandes utiles:
   docker-compose logs -f     # Logs en temps réel
   docker-compose restart     # Redémarrer tous les services
   curl -v https://purpleguy.world    # Test HTTPS
ubuntu@vps-41d62757:~/REM-Bennes$
